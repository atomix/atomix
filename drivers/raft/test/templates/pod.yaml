# SPDX-FileCopyrightText: 2022-present Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0

apiVersion: v1
kind: Pod
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
  labels:
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
    sidecar.atomix.io/inject: "true"
    runtime.atomix.io/profile: {{ .Release.Name }}
  annotations:
    "helm.sh/hook": test
    {{- if .Values.sidecar.image.tag }}
    sidecar.atomix.io/image: {{ printf "%s:%s" .Values.sidecar.image.repository .Values.sidecar.image.tag }}
    {{- end }}
    {{- with .Values.sidecar.image.pullPolicy }}
    sidecar.atomix.io/imagePullPolicy: {{ . }}
    {{- end }}
spec:
  shareProcessNamespace: true
  containers:
    - name: atomix-test
      {{- if .Values.image.tag }}
      image: {{ printf "%s:%s" .Values.image.repository .Values.image.tag }}
      {{- else if .Chart.AppVersion }}
      image: {{ printf "%s:%s" .Values.image.repository .Chart.AppVersion }}
      {{- else }}
      image: {{ .Values.image.repository }}
      {{- end }}
      imagePullPolicy: {{ .Values.image.pullPolicy }}
      command:
        - /bin/bash
        - -c
        - atomix-test && pkill atomix-sidecar
  restartPolicy: Never
