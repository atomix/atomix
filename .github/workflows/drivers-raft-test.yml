# Code generated by build-workflows script. DO NOT EDIT.
# source: drivers/raft/.github/workflows/test.yml

# SPDX-FileCopyrightText: 2023-present Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0

name: Test Raft Driver

on:
  push:
    branches:
      - 'master'
      - 'test'
    paths:
      - 'drivers/raft/**'
      - 'stores/raft/**'
      - 'test/**'
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-controller:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build image
        uses: docker/build-push-action@v3
        with:
          context: controller
          file: controller/build/controller/Dockerfile
          tags: atomix/controller
          outputs: type=docker,dest=/tmp/controller.tar

      - name: Share image
        uses: actions/upload-artifact@v3
        with:
          name: controller
          path: /tmp/controller.tar

  build-controller-init:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build image
        uses: docker/build-push-action@v3
        with:
          context: controller
          file: controller/build/controller-init/Dockerfile
          tags: atomix/controller-init
          outputs: type=docker,dest=/tmp/controller-init.tar

      - name: Share image
        uses: actions/upload-artifact@v3
        with:
          name: controller-init
          path: /tmp/controller-init.tar

  build-raft-node:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build image
        uses: docker/build-push-action@v3
        with:
          context: stores/raft
          file: stores/raft/build/node/Dockerfile
          tags: atomix/raft-node
          outputs: type=docker,dest=/tmp/raft-node.tar

      - name: Share image
        uses: actions/upload-artifact@v3
        with:
          name: raft-node
          path: /tmp/raft-node.tar

  build-raft-controller:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build image
        uses: docker/build-push-action@v3
        with:
          context: stores/raft
          file: stores/raft/build/controller/Dockerfile
          tags: atomix/raft-controller
          outputs: type=docker,dest=/tmp/raft-controller.tar

      - name: Share image
        uses: actions/upload-artifact@v3
        with:
          name: raft-controller
          path: /tmp/raft-controller.tar

  build-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build image
        uses: docker/build-push-action@v3
        with:
          file: drivers/test/build/Dockerfile
          tags: atomix/driver-test:raft
          build-args: |
            driver=raft
            version=v1
          outputs: type=docker,dest=/tmp/test.tar

      - name: Share image
        uses: actions/upload-artifact@v3
        with:
          name: test
          path: /tmp/test.tar

  run-tests:
    runs-on: ubuntu-latest

    needs:
      - build-controller
      - build-controller-init
      - build-raft-node
      - build-raft-controller
      - build-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Setup Helm
        uses: ./.github/actions/setup-helm

      - name: Create kind cluster
        uses: helm/kind-action@v1.4.0
        with:
          cluster_name: kind

      - name: Fetch atomix/controller
        uses: actions/download-artifact@v3
        with:
          name: controller
          path: /tmp

      - name: Fetch atomix/controller-init
        uses: actions/download-artifact@v3
        with:
          name: controller-init
          path: /tmp

      - name: Fetch atomix/raft-node
        uses: actions/download-artifact@v3
        with:
          name: raft-node
          path: /tmp

      - name: Fetch atomix/raft-controller
        uses: actions/download-artifact@v3
        with:
          name: raft-controller
          path: /tmp

      - name: Fetch atomix/test
        uses: actions/download-artifact@v3
        with:
          name: test
          path: /tmp

      - name: Load Docker images
        run: |
          kind load image-archive /tmp/controller.tar
          kind load image-archive /tmp/controller-init.tar
          kind load image-archive /tmp/raft-node.tar
          kind load image-archive /tmp/raft-controller.tar
          kind load image-archive /tmp/test.tar

      - name: Install core controller
        run: helm install -n kube-system atomix-controller ./controller/chart --set image.pullPolicy=Never --set init.image.pullPolicy=Never --wait

      - name: Install store controller
        run: helm install -n kube-system atomix-raft-controller ./stores/raft/chart --set image.pullPolicy=Never --wait

      - name: Run driver tests
        run: ct install --charts ./drivers/raft/test

      - name: Record k8s status
        if: failure()
        run: |
          echo "kubectl get pods"
          kubectl get pods
          echo "kubectl get pods -n kube-system"
          kubectl get pods -n kube-system
          echo "kubectl get storageprofiles"
          kubectl get storageprofiles
          echo "kubectl get datastores"
          kubectl get datastores
          echo "kubectl get raftclusters"
          kubectl get raftclusters
          echo "kubectl get raftstores"
          kubectl get raftstores
          echo "kubectl get raftpartitions"
          kubectl get raftpartitions
          echo "kubectl get raftreplicas"
          kubectl get raftreplicas
