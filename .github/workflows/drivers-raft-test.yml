# Code generated by build-workflows script. DO NOT EDIT.
# source: drivers/raft/.github/workflows/test.yml

# SPDX-FileCopyrightText: 2023-present Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0

name: Test raft driver

on:
  push:
    branches:
      - 'master'
      - 'actions'
    paths:
      - 'controller/**'
      - 'sidecar/**'
      - 'drivers/raft/**'
      - 'stores/raft/**'
      - 'test/**'
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-primitives:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: Setup Helm
        uses: ./.github/actions/setup-helm

      - name: Create kind cluster
        uses: helm/kind-action@v1.4.0
        with:
          cluster_name: kind

      - name: Make CLI
        run: make
        working-directory: cli

      - name: Build atomix/cli
        uses: docker/build-push-action@v3
        with:
          context: cli/build
          tags: atomix/cli
          load: true
          push: false

      - name: Build atomix/sidecar
        uses: docker/build-push-action@v3
        with:
          context: .
          file: drivers/raft/test/Dockerfile
          tags: atomix/sidecar
          load: true
          push: false

      - name: Load atomix/sidecar
        run: kind load docker-image atomix/sidecar

      - name: Make sidecar controller
        run: make controller
        working-directory: sidecar

      - name: Build atomix/sidecar-controller
        uses: docker/build-push-action@v3
        with:
          context: sidecar/build/controller
          tags: atomix/sidecar-controller
          load: true
          push: false

      - name: Load atomix/sidecar-controller
        run: kind load docker-image atomix/sidecar-controller

      - name: Make controller
        run: make
        working-directory: controller

      - name: Build atomix/controller
        uses: docker/build-push-action@v3
        with:
          context: controller/build/controller
          tags: atomix/controller
          load: true
          push: false

      - name: Load atomix/controller
        run: kind load docker-image atomix/controller

      - name: Build atomix/controller-init
        uses: docker/build-push-action@v3
        with:
          context: controller/build/controller-init
          tags: atomix/controller-init
          load: true
          push: false

      - name: Load atomix/controller-init
        run: kind load docker-image atomix/controller-init

      - name: Make store
        run: make
        working-directory: stores/raft

      - name: Build atomix/raft-controller
        uses: docker/build-push-action@v3
        with:
          context: stores/raft/build/controller
          tags: atomix/raft-controller
          load: true
          push: false

      - name: Load atomix/raft-controller
        run: kind load docker-image atomix/raft-controller

      - name: Build atomix/raft-node
        uses: docker/build-push-action@v3
        with:
          context: stores/raft/build/node
          tags: atomix/raft-node
          load: true
          push: false

      - name: Load atomix/raft-node
        run: kind load docker-image atomix/raft-node

      - name: Make tests
        run: make
        working-directory: test

      - name: Build atomix/test
        uses: docker/build-push-action@v3
        with:
          context: test/build
          tags: atomix/test
          load: true
          push: false

      - name: Load atomix/test
        run: kind load docker-image atomix/test

      - name: Install core controller
        run: helm install -n kube-system atomix-controller ./controller/chart --set image.pullPolicy=Never --set init.image.pullPolicy=Never --wait

      - name: Install sidecar controller
        run: helm install -n kube-system atomix-sidecar-controller ./sidecar/chart --set image.pullPolicy=Never --wait

      - name: Install store controller
        run: helm install -n kube-system atomix-raft-controller ./stores/raft/chart --set image.pullPolicy=Never --wait

      - name: Setup tests
        run: kubectl create -f drivers/raft/test/setup.yaml

      - name: Install tests
        run: helm install test ./test/chart -f drivers/raft/test/suite.yaml --set image.pullPolicy=Never --wait

      - name: Test Counter/v1
        run: helm test test --filter name=test-counter-v1

      - name: Test Map/v1
        run: helm test test --filter name=test-map-v1

      - name: Record k8s status
        if: failure()
        run: |
          echo "kubectl get pods"
          kubectl get pods
          echo "kubectl get pods -n kube-system"
          kubectl get pods -n kube-system
          echo "kubectl get storageprofiles"
          kubectl get storageprofiles
          echo "kubectl get datastores"
          kubectl get datastores
          echo "kubectl get raftclusters"
          kubectl get raftclusters
          echo "kubectl get raftstores"
          kubectl get raftstores
          echo "kubectl get raftpartitions"
          kubectl get raftpartitions
          echo "kubectl get raftreplicas"
          kubectl get raftreplicas
