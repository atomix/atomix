#!/bin/bash
# SPDX-FileCopyrightText: 2022-present Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0

readonly ROOT_WF_DIR=".github/workflows"

DIRS="$(find . -mindepth 2 -name '*.yml' -type f -not -path "./.git*/*")"

for file in $DIRS; do
  source=$(echo "$file" | sed 's/^.\///g')
  prefix=$(echo "$(dirname $(dirname $(dirname "$source")))" | sed 's/\//-/g')
  find $ROOT_WF_DIR -type f -name "$prefix-*.yml" -delete
done

for file in $DIRS; do
  source=$(echo "$file" | sed 's/^.\///g')
  prefix=$(echo "$(dirname $(dirname $(dirname "$source")))" | sed 's/\//-/g')
  dest="$ROOT_WF_DIR/$prefix-$(basename "$source")"
  echo "$source -> $dest"
  echo "# Code generated by build-workflows script. DO NOT EDIT." >> $dest
  echo "# source: $source" >> $dest
  echo "" >> $dest
  cat "$source" >> "$dest"
done