# SPDX-FileCopyrightText: 2022-present Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0

{{- $chart := .Chart }}
{{- $release := .Release }}
{{- $values := .Values }}
{{- range $i, $test := .Values.tests }}
{{- $name := ( lower ( default ( printf "%s-%s" $test.kind $test.apiVersion ) $test.name ) ) }}
{{- range $t := $values.tests }}
  {{- if ( and ( eq $t.kind $test.kind ) ( eq $t.apiVersion $test.apiVersion ) ) }}
    {{- $name = ( lower ( default ( printf "%s-%s-%d" $test.kind $test.apiVersion $i ) $test.name ) ) }}
  {{- end }}
{{- end }}

---

apiVersion: v1
kind: Pod
metadata:
  name: {{ $name }}
  labels:
    name: {{ $name }}
    sidecar.atomix.io/inject: "true"
    runtime.atomix.io/profile: {{ $name }}
  annotations:
    helm.sh/hook: test
    {{- if $values.sidecar.image.tag }}
    sidecar.atomix.io/image: {{ printf "%s:%s" $values.sidecar.image.repository $values.sidecar.image.tag }}
    {{- end }}
    {{- with $values.sidecar.image.pullPolicy }}
    sidecar.atomix.io/imagePullPolicy: {{ . }}
    {{- end }}
spec:
  shareProcessNamespace: true
  containers:
    - name: atomix-test
      {{- if $values.image.tag }}
      image: {{ printf "%s:%s" $values.image.repository $values.image.tag }}
      {{- else if $chart.AppVersion }}
      image: {{ printf "%s:%s" $values.image.repository $chart.AppVersion }}
      {{- else }}
      image: {{ $values.image.repository }}
      {{- end }}
      imagePullPolicy: {{ $values.image.pullPolicy }}
      command:
        - /bin/bash
        - -c
        - atomix-test {{ $name }} --kind {{ $test.kind }} --api-version {{ $test.apiVersion }} && pkill atomix-sidecar
  restartPolicy: Never

---

apiVersion: atomix.io/v3beta4
kind: StorageProfile
metadata:
  name: {{ $name }}
  labels:
    name: {{ $name }}
spec:
  routes:
    - store:
        name: {{ $release.Name }}
      rules:
        - kind: {{ $test.kind }}
          apiVersion: {{ $test.apiVersion }}
          {{- if $test.config }}
          config:
            {{ toYaml $test.config | nindent 12 }}
          {{- end }}

{{- end }}
